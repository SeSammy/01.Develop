# Avaya録音関連技術の体系整理
（目的：Avaya PBX・AES環境の理解と録音制御設計の基礎確立）

---

## 1. Avaya通信体系の全体構造

Avaya Communication Manager（CM）は音声通信のコアであり、
**通話制御・呼情報管理・端末制御・CTI連携**を一元的に担う。

上位に以下の制御層が存在する：

| 層 | 主な機能 | 主なプロトコル |
|----|-----------|----------------|
| 呼制御層 | 内線/外線通話のセッション確立 | H.323 / SIP / ISDN |
| 信号制御層 | ボタン・LED・状態制御 | H.225 / Q.931 / D-channel |
| CTI層 | 外部制御・イベント配信 | ASAI / TSAPI（AES経由） |
| 管理層 | 管理・設定・ログ | SNMP / SAT / Web管理 |

---

## 2. Avayaにおける通話制御方式の種類

### (1) H.323ベースの内線制御

- **端末登録**: H.225のRAS（Registration, Admission, Status）を利用し、IP端末がCMへ登録。
- **通話確立**: Facility（OpenLogicalChannel）でRTP経路を開設。
- **特徴**:
  - Connect/Disconnectイベントを使わず、Information/Facilityで状態を表現する独自実装。
  - 複数アピアランス（同一番号を複数端末に割当）対応。
  - 保留・転送・会議操作はFacilityメッセージで状態遷移。

> CMはH.323を標準実装しているが、Avayaは独自拡張（H.323+ASAI連携）により詳細な呼情報を保持。

---

### (2) SIPベースの呼制御

- **通話確立**: INVITE → 180 Ringing → 200 OK → ACK
- **通話終了**: BYE
- **機能拡張**: SUBSCRIBE/NOTIFYを用いて端末状態を更新（LED点灯、BLF制御など）。
- **特徴**:
  - 標準的なSIP動作を踏襲しつつ、Avaya独自のヘッダ拡張を追加。
  - 代表的ヘッダ：P-Asserted-Identity（発信内線情報の伝達）
  - 端末間の転送／会議時に複数RTPストリームが生成されることがある。

---

### (3) デジタル（TDM）制御

- **通信経路**: PBX内部の2線デジタル回路で制御信号と音声信号を多重化。
- **制御単位**: ボタン操作、ディスプレイ表示、LED状態など。
- **特徴**:
  - CMから端末への電圧・制御信号変化で通話状態を通知。
  - 内線転送時には物理チャンネルを再割当。
  - 音声はPCM方式で伝送（64kbps／G.711等）。

---

### (4) トランク制御（外線）

- **対象**: アナログ、BRI、PRI、ISDN。
- **プロトコル**: ISDNはQ.931、Q-SIGは非対応（Avaya CMではQ-SIGはデータリンク非公開）。
- **物理分岐**: ST点で分岐し、チャネルごとに制御信号を送受。
- **呼制御単位**: トランクチャネル（1ch単位）。

---

## 3. Avaya AES（Application Enablement Services）

AESは、Avaya Communication Manager（CM）と外部システム間の**CTIブリッジ**である。
通話・エージェント・VDN（Virtual Directory Number）等のイベントを外部に配信する。

### 主なコンポーネントと役割

| コンポーネント | 機能 |
|----------------|------|
| TSAPI (Telephony Service API) | イベント制御・モニタリングAPI（外部アプリ用） |
| DMCC (Device, Media, and Call Control) | ソフトフォン制御API（音声ストリーム制御も可能） |
| CVLAN | CMとのセッション管理層（ASAI通信を仲介） |
| AE Server | TSAPI／DMCCのアプリホスト、API要求処理を実行 |

---

## 4. TSAPIによる制御モデル

AES上で動作するTSAPIは、通話イベントを細かく分解して通知する。

### 代表的イベントと意味

| イベント名 | 内容 | 利用例 |
|-------------|------|--------|
| **OriginatedEvent** | 発信動作の検知 | 内線発信時の開始トリガー |
| **DeliveredEvent** | 相手先へ着信通知 | 着信ログ生成 |
| **EstablishedEvent** | 通話確立 | 通話時間計測や録音トリガー |
| **ConnectionClearedEvent** | 通話終了 | ログ確定・処理終了 |
| **ConferencedEvent** | 会議通話確立 | 会議検出・UCID継承 |
| **TransferredEvent** | 転送完了 | 新旧CallIDの紐付け |

### 主要データ項目
- **CallID / UCID**: 通話識別子（グローバル一意）
- **VDN / Split**: コールセンタ構造内のルーティング情報
- **UserEnteredCode**: 端末入力コード（業務コード、理由コード等）
- **AgentID / StationID**: エージェント識別情報
- **DistributingVDN / TrunkGroup**: ルーティング経路情報

### イベントの関係
- 発信／着信 → Established → ConnectionCleared
- 転送時は TransferredEvent で新旧CallIDを紐付け
- UCIDは通話をまたいで継承される（録音・分析系で必須）

---

## 5. AESの冗長構成

### 冗長化モデル
- **複数AESサーバ登録**が可能。
- CM側およびクライアント側から同時にOpenStreamを実行。
- **MonitorDevice()**はアクティブ1台にのみ設定。
- 監視間隔（デフォルト20秒）で通信死活確認。

### 切替条件
- AES側通信断（TCPレイヤでの切断検知）
- AES–CM間リンク切断（ASAIセッション断）
→ 次順位AESへ自動切替。Monitorを再登録。

---

## 6. ASAI（Adjunct Switch Application Interface）

- CM内部とAESを接続するためのAvaya独自インターフェース。
- **CTI連携の最下層プロトコル**であり、TSAPIやCVLANの基盤。
- **Private Data Version 11以降**で端末IPアドレス情報を保持可能。
- **ASAI Link Version 6**以降でAESとの連携安定性が大幅向上。

---

## 7. エージェントおよびVDN構造

### VDN (Virtual Directory Number)
- 仮想的なダイヤルポイント。スキルルーティングの入口。
- 呼はVDN → Split（スキルグループ）→ Agent へ流れる。
- CTIでは `distributingVDN` として識別可能。

### Split / Skill
- 1つの業務単位に紐付く論理グループ。
- TSAPIイベントでは `split` 項目で通知。
- 例: Split 101 → クレーム窓口、Split 102 → 新規受付

### Agent
- AgentID で識別。AESはCMのStation情報を照会して名前／状態を返す。
- QueryDeviceInfo() で取得可能。

---

## 8. Avayaでの呼識別（UCIDの役割）

- **UCID (Universal Call ID)** はAvaya固有の通話識別子。
- 通話が転送・会議・スプリットを跨いでも一意に維持。
- CM設定で `Generate UCID = y` にすると全通話で付与される。
- TSAPIで `establishedEvent.ucid` として通知。
- 録音や分析では、このUCIDで通話を論理的に一体化する。

---

## 9. 通信トポロジと実装上の要点

- **CM**：音声制御の中核。各端末とRTPを確立。
- **AES**：CTIイベントを中継。
- **DMCCクライアント**：TSAPI経由で制御情報を受信。
- **複数AES**：負荷分散と冗長化。
- **ネットワーク監視**：RTPの双方向トラフィックが観測可能なSPAN設計が必須。

---

## 10. 典型的な通信フロー例（H.323内線）

1. 端末A → CM → 端末B
2. 端末A: RAS(Register) → CMへ登録
3. CM: Admission Confirm → 呼可否判断
4. CM: Setup → 端末Bへ呼出
5. 端末B: Alerting → CM → AへRinging
6. Facility (OpenLogicalChannel) → RTP経路確立
7. 通話確立（Established）
8. いずれか切断 → Facility Close → RTP終了


---

## 11. 運用・設計上の留意点

1. **UCID生成設定**を必ず有効化（録音・分析連携の基盤）
2. **Private Data Ver.11以降**推奨（IPアドレス管理の簡略化）
3. **AES冗長構成**を標準設計にする（切替時間≦30秒目安）
4. **CTI障害時の補助トリガー**を設計に含める（録音漏れ防止）
5. **H.323とSIPの共存環境**では、呼制御仕様の差異を事前把握
6. **会議／転送のUCID継承確認**を試験項目に含める

---

## 12. Avaya録音技術の本質的理解

- Avayaの録音連携は「**呼制御構造をどう観測・理解するか**」に尽きる。
- AESは単なるCTIサーバではなく、**CMの通話構造を可視化するためのAPI層**。
- H.323やSIPを直接読むより、**TSAPIイベント群とASAI拡張情報**を理解する方が早い。
- UCIDを中心に据えた「論理的通話単位」の管理こそが、録音・分析・品質評価の共通基盤である。

---

### 最終まとめ
> **Avaya録音理解の核 = 「呼制御（H.323/SIP） × CTI制御（AES/TSAPI） × UCID論理構造」**
> これを把握すれば、録音装置に依存せず Avaya 環境を俯瞰・設計できる。

